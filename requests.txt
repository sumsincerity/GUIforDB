1. Какие блюда наиболее популярны в каждом заведении?
SELECT
    r.name AS restaurant,
    d.name AS dish,
    SUM(oi.qty) AS total_ordered
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.name
ORDER BY r.name, total_ordered DESC;

2. Какие блюда не были заказаны ни разу?
SELECT
    r.name AS restaurant,
    d.name AS dish
FROM dishes d
JOIN restaurants r ON d.restaurant_id = r.id
LEFT JOIN order_items oi ON d.id = oi.dish_id
WHERE oi.dish_id IS NULL
ORDER BY r.name, d.name;

3. Какие блюда недоступны в текущий момент?
SELECT
    r.name AS restaurant,
    d.name AS dish
FROM dishes d
JOIN restaurants r ON d.restaurant_id = r.id
WHERE d.is_available = FALSE
ORDER BY r.name, d.name;

4.Какие временные слоты самые загруженные для каждого заведения?
SELECT
    r.name AS restaurant,
    EXTRACT(HOUR FROM o.order_time) AS hour_of_day,
    COUNT(*) AS order_count
FROM orders o
JOIN restaurants r ON o.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, hour_of_day
ORDER BY r.name, order_count DESC;

5. Какие заведения самые загруженные с 18:00 до 21:00?
SELECT
    r.name AS restaurant,
    COUNT(*) AS order_count
FROM orders o
JOIN restaurants r ON o.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
  AND EXTRACT(HOUR FROM o.order_time) BETWEEN 18 AND 20
GROUP BY r.name
ORDER BY order_count DESC;

6. Сколько заказов обработал каждый сотрудник?
SELECT
    e.full_name AS employee,
    COUNT(DISTINCT o.id) AS orders_handled
FROM orders o
JOIN app_users au ON o.created_by_user = au.id
JOIN employees e ON au.employee_id = e.id
WHERE o.status IN ('completed', 'served')
GROUP BY e.full_name
ORDER BY orders_handled DESC;

7. Какую прибыль принёс каждый сотрудник?
SELECT
    e.full_name AS employee,
    COALESCE(SUM(o.total_amount), 0) AS total_revenue
FROM orders o
JOIN app_users au ON o.created_by_user = au.id
JOIN employees e ON au.employee_id = e.id
WHERE o.status IN ('completed', 'served')
GROUP BY e.full_name
ORDER BY total_revenue DESC;

8. Какие ингредиенты используются чаще всего?
SELECT
    i.name AS ingredient,
    SUM(di.qty_required * oi.qty) AS total_used
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN dish_ingredients di ON d.id = di.dish_id
JOIN ingredients i ON di.ingredient_id = i.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY i.name
ORDER BY total_used DESC;

9. В какое время дня заказывают больше всего блюд?
SELECT
    EXTRACT(HOUR FROM o.order_time) AS hour_of_day,
    SUM(oi.qty) AS total_dishes
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
WHERE o.status IN ('completed', 'served')
GROUP BY hour_of_day
ORDER BY total_dishes DESC
LIMIT 1;

10. Какие блюда можно предложить в качестве альтернативы недоступным?
SELECT
    d_unavail.name AS unavailable_dish,
    r.name AS restaurant,
    alt.name AS alternative_dish
FROM dishes d_unavail
JOIN restaurants r ON d_unavail.restaurant_id = r.id
JOIN LATERAL (
    SELECT * FROM fn_suggest_alternatives(d_unavail.id, r.id, 3)
) alt ON true
WHERE d_unavail.is_available = FALSE;


11. Какие данные можно использовать для прогнозирования спроса?
-- Данные для прогнозирования спроса: суточный спрос на блюда
SELECT
    d.name AS dish_name,
    r.name AS restaurant_name,
    d.category,
    DATE(o.order_time) AS order_date,
    SUM(oi.qty) AS daily_quantity,
    COUNT(DISTINCT o.id) AS daily_orders
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
  AND o.order_time >= now() - INTERVAL '90 days'  -- за последние 90 дней
GROUP BY d.name, r.name, d.category, DATE(o.order_time)
ORDER BY r.name, d.name, order_date;

-- Средний спрос по дням недели
SELECT
    d.name AS dish_name,
    EXTRACT(DOW FROM o.order_time) AS day_of_week,  -- 0=вс, 1=пн, ...
    AVG(oi.qty) AS avg_qty_per_order,
    SUM(oi.qty) AS total_qty,
    COUNT(*) AS total_orders
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
JOIN dishes d ON oi.dish_id = d.id
WHERE o.status IN ('completed', 'served')
GROUP BY d.name, day_of_week
ORDER BY d.name, day_of_week;

12. Какие категории блюд приносят наибольшую прибыль в каждом заведении?
SELECT
    r.name AS restaurant,
    d.category,
    SUM(oi.qty * oi.price_at_order) AS category_revenue
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.category
ORDER BY r.name, category_revenue DESC;

13. Какие блюда самые прибыльные?
SELECT
    r.name AS restaurant,
    d.name AS dish,
    SUM(oi.qty * oi.price_at_order) AS total_revenue
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.name
ORDER BY total_revenue DESC
LIMIT 10;

14. Какие ингредиенты используются чаще всего в популярных блюдах?
WITH popular_dishes AS (
    SELECT d.id
    FROM order_items oi
    JOIN dishes d ON oi.dish_id = d.id
    JOIN orders o ON oi.order_id = o.id
    WHERE o.status IN ('completed', 'served')
    GROUP BY d.id
    ORDER BY SUM(oi.qty) DESC
    LIMIT 10
)
SELECT
    i.name AS ingredient,
    SUM(di.qty_required * oi.qty) AS total_used_in_popular
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN dish_ingredients di ON d.id = di.dish_id
JOIN ingredients i ON di.ingredient_id = i.id
JOIN orders o ON oi.order_id = o.id
JOIN popular_dishes pd ON d.id = pd.id
WHERE o.status IN ('completed', 'served')
GROUP BY i.name
ORDER BY total_used_in_popular DESC;


Cluster 0 — популярные дешёвые
Cluster 1 — редкие дорогие
Cluster 2 — ключевые блюда меню