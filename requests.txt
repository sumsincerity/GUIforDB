1. Какие блюда наиболее популярны в каждом заведении?
SELECT r.name AS restaurant, d.name AS dish, SUM(oi.qty) AS total_ordered
FROM order_items AS oi
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.name
ORDER BY r.name, total_ordered DESC;


2. Какие блюда не были заказаны ни разу?
SELECT r.name AS restaurant, d.name AS dish
FROM dishes AS d
JOIN restaurants r ON d.restaurant_id = r.id
LEFT JOIN order_items oi ON d.id = oi.dish_id
WHERE oi.dish_id IS NULL
ORDER BY r.name, d.name;

3. Какие блюда недоступны в текущий момент?
SELECT r.name AS restaurant, d.name AS dish
FROM dishes AS d
JOIN restaurants r ON d.restaurant_id = r.id
WHERE d.is_available = FALSE
ORDER BY r.name, d.name;

4. Какие временные слоты самые загруженные для каждого заведения?
SELECT r.name AS restaurant, EXTRACT(HOUR FROM o.order_time) AS hour_of_day,
COUNT(*) AS order_count
FROM orders AS o
JOIN restaurants AS r ON o.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, hour_of_day
ORDER BY r.name, order_count DESC;

5. Какие заведения самые загруженные с 18:00 до 21:00?
SELECT r.name AS restaurant, COUNT(*) AS order_count
FROM orders AS o
JOIN restaurants AS r ON o.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
AND EXTRACT(HOUR FROM o.order_time) BETWEEN 18 AND 20
GROUP BY r.name
ORDER BY order_count DESC;

6. Сколько заказов обработал каждый сотрудник?
SELECT e.full_name AS employee, COUNT(DISTINCT o.id) AS orders_handled
FROM orders AS o
JOIN app_users AS au ON o.created_by_user = au.id
JOIN employees AS e ON au.employee_id = e.id
WHERE o.status IN ('completed', 'served')
GROUP BY e.full_name
ORDER BY orders_handled DESC;

7. Какую прибыль принёс каждый сотрудник?
SELECT e.full_name AS employee, COALESCE(SUM(o.total_amount), 0) AS total_revenue
FROM orders AS o
JOIN app_users AS au ON o.created_by_user = au.id
JOIN employees AS e ON au.employee_id = e.id
WHERE o.status IN ('completed', 'served')
GROUP BY e.full_name
ORDER BY total_revenue DESC;

8. Какие ингредиенты используются чаще всего?
SELECT i.name AS ingredient, SUM(di.qty_required * oi.qty) AS total_used
FROM order_items AS oi
JOIN dishes AS d ON oi.dish_id = d.id
JOIN dish_ingredients AS di ON d.id = di.dish_id
JOIN ingredients AS i ON di.ingredient_id = i.id
JOIN orders AS o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY i.name
ORDER BY total_used DESC;

9. В какое время дня заказывают больше всего блюд?
SELECT EXTRACT(HOUR FROM o.order_time) AS hour_of_day, SUM(oi.qty) AS total_dishes
FROM orders AS o
JOIN order_items AS oi ON o.id = oi.order_id
WHERE o.status IN ('completed', 'served')
GROUP BY hour_of_day
ORDER BY total_dishes DESC
LIMIT 1;

10. Какие блюда можно предложить в качестве альтернативы недоступным?
SELECT d_unavail.name AS unavailable_dish, r.name AS restaurant, alt.name AS alternative_dish
FROM dishes AS d_unavail
JOIN restaurants AS r ON d_unavail.restaurant_id = r.id
JOIN LATERAL (SELECT * FROM fn_suggest_alternatives(d_unavail.id, r.id, 3)) alt ON true
WHERE d_unavail.is_available = FALSE;

11. Какие данные можно использовать для прогнозирования спроса?
SELECT
	d.name AS dish_name,
	r.name AS restaurant_name,
	d.category, DATE(o.order_time) AS order_date,
	SUM(oi.qty) AS daily_quantity,
	COUNT(DISTINCT o.id) AS daily_orders
FROM orders AS o
JOIN order_items oi ON o.id = oi.order_id
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
WHERE o.status IN ('completed', 'served')
AND o.order_time >= now() - INTERVAL '90 days'
GROUP BY d.name, r.name, d.category, DATE(o.order_time)
ORDER BY r.name, d.name, order_date;

12. Средний спрос по дням недели
SELECT d.name AS dish_name, EXTRACT(DOW FROM o.order_time) AS day_of_week, AVG(oi.qty) AS avg_qty_per_order, SUM(oi.qty) AS total_qty, COUNT(*) AS total_orders FROM orders o JOIN order_items oi ON o.id = oi.order_id JOIN dishes d ON oi.dish_id = d.id WHERE o.status IN ('completed', 'served') GROUP BY d.name, day_of_week ORDER BY d.name, day_of_week;

13. Какие категории блюд приносят наибольшую прибыль в каждом заведении?
SELECT r.name AS restaurant, d.category,
SUM(oi.qty * oi.price_at_order) AS category_revenue
FROM order_items AS oi
JOIN dishes AS d ON oi.dish_id = d.id
JOIN restaurants AS r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.category
ORDER BY r.name, category_revenue DESC;

14. Какие блюда самые прибыльные?
SELECT r.name AS restaurant, d.name AS dish,
SUM(oi.qty * oi.price_at_order) AS total_revenue
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN restaurants r ON d.restaurant_id = r.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY r.name, d.name
ORDER BY total_revenue DESC
LIMIT 10;

15. Какие ингредиенты используются чаще всего в популярных блюдах?
WITH popular_dishes AS (
SELECT d.id FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('completed', 'served')
GROUP BY d.id
ORDER BY SUM(oi.qty) DESC
LIMIT 10
)
SELECT i.name AS ingredient,
SUM(di.qty_required * oi.qty) AS total_used_in_popular
FROM order_items oi
JOIN dishes d ON oi.dish_id = d.id
JOIN dish_ingredients di ON d.id = di.dish_id
JOIN ingredients i ON di.ingredient_id = i.id
JOIN orders o ON oi.order_id = o.id
JOIN popular_dishes pd ON d.id = pd.id
WHERE o.status IN ('completed', 'served')
GROUP BY i.name
ORDER BY total_used_in_popular DESC;

16. Все сотрудники имеют аккаунты?
SELECT e.full_name, u.username, aur.restaurant_id, ar.name AS role
FROM employees e
JOIN app_users u ON e.id = u.employee_id
JOIN app_user_roles aur ON u.id = aur.user_id
JOIN app_roles ar ON aur.role_id = ar.id
ORDER BY e.full_name;

17. ЗАКАЗЫ ОФИЦИАНТЫ - пользователи и роли
SELECT u.username, ar.name AS role, r.name AS restaurant
FROM app_user_roles aur
JOIN app_users u ON aur.user_id = u.id
JOIN app_roles ar ON aur.role_id = ar.id
LEFT JOIN restaurants r ON aur.restaurant_id = r.id
ORDER BY u.username;

18. ЗАКАЗЫ ОФИЦИАНТЫ - заказы
SELECT u.username, ar.name AS role, r.name AS restaurant
FROM app_user_roles aur
JOIN app_users u ON aur.user_id = u.id
JOIN app_roles ar ON aur.role_id = ar.id
LEFT JOIN restaurants r ON aur.restaurant_id = r.id
ORDER BY u.username;

19. БЛЮДА
SELECT id, restaurant_id, name FROM dishes ORDER BY id;

20. финал
SELECT fn_finalize_order(1, (SELECT id FROM app_users WHERE username = 'waiter1'));

21. Проверка автозаявки - проверка заявок
SELECT * FROM purchase_requests WHERE restaurant_id = 1 AND ingredient_id = 5;

22. Проверка доступности - обновление доступности блюд
SELECT fn_update_dishes_availability_for_restaurant(2);

23. Проверка доступности - альтернативы
SELECT * FROM fn_suggest_alternatives(6, 2);
