{% extends "base.html" %}
{% block content %}
{% set perms = permissions %}
<style>
  .card-header-line {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid #e0e0e0;
  }
</style>
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-home" type="button">–ì–ª–∞–≤–Ω–∞—è</button>
  </li>
  {% if "tables" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tables" type="button">–¢–∞–±–ª–∏—Ü—ã</button>
  </li>
  {% endif %}
  {% if "inventory" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inv" type="button">–ó–∞–ø–∞—Å—ã</button>
  </li>
  {% endif %}
  {% if "purchase" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-purchase" type="button">–ó–∞—è–≤–∫–∏</button>
  </li>
  {% endif %}
  {% if "orders" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-orders" type="button">–ó–∞–∫–∞–∑—ã</button>
  </li>
  {% endif %}
  {% if "menu" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-menu" type="button">–ú–µ–Ω—é</button>
  </li>
  {% endif %}
  {% if "reports" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reports" type="button">–û—Ç—á—ë—Ç—ã</button>
  </li>
  {% endif %}
  {% if "admin" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users" type="button">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
  </li>
  {% endif %}
  {% if "query" in perms %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-query" type="button">SQL</button>
  </li>
  {% endif %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-help" type="button">–°–ø—Ä–∞–≤–∫–∞</button>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="tab-home">
    <div class="card p-3 mb-3">
      <div class="card-header-line">
        <h5 class="mb-0">–û–±–∑–æ—Ä</h5>
        <span class="badge bg-secondary ms-2">Dashboard</span>
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="p-3 bg-light border rounded">
            <div class="text-muted small">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div class="fw-bold">{{ username }}</div>
            <div class="text-muted small">–†–æ–ª—å: {{ role }}</div>
            {% if current_restaurant %}
            <div class="text-muted small">–¢–µ–∫—É—â–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω: {{ current_restaurant }}</div>
            {% endif %}
          </div>
        </div>
        <div class="col-md-8">
          <div class="p-3 bg-light border rounded">
            <div class="d-flex justify-content-between">
              <div>
                <div class="text-muted small">–ó–∞–∫–∞–∑—ã (–≤—Å–µ–≥–æ)</div>
                <div class="fw-bold">{{ stats.orders }}</div>
              </div>
              <div>
                <div class="text-muted small">–ó–∞–ø–∞—Å—ã (—Å—Ç—Ä–æ–∫)</div>
                <div class="fw-bold">{{ stats.stocks }}</div>
              </div>
              <div>
                <div class="text-muted small">–ë–ª—é–¥–∞</div>
                <div class="fw-bold">{{ stats.dishes }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º</h6>
        <span class="badge bg-secondary ms-2">Analytics</span>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th>
              <th>–ó–∞–∫–∞–∑—ã (—à—Ç)</th>
              <th>–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤</th>
              <th>–°—Ç—Ä–æ–∫ –≤ –∑–∞–ø–∞—Å–∞—Ö</th>
            </tr>
          </thead>
          <tbody>
            {% for r in summary %}
            <tr>
              <td>{{ r.restaurant_name }}</td>
              <td>{{ r.orders_count }}</td>
              <td>{{ r.orders_sum }}</td>
              <td>{{ r.stocks_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card p-3">
            <div class="card-header-line">
              <h6 class="mb-0">–ó–∞–∫–∞–∑—ã –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º (—Å—É–º–º–∞)</h6>
              <span class="badge bg-secondary ms-2">Chart</span>
            </div>
            <div class="chart-container">
              <canvas id="chartOrdersSum"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card p-3">
            <div class="card-header-line">
              <h6 class="mb-0">–ó–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h6>
              <span class="badge bg-secondary ms-2">Chart</span>
            </div>
            <div class="chart-container">
              <canvas id="chartStatus"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if "query" in perms %}
  <div class="tab-pane fade" id="tab-query">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">SQL</h6>
        <span class="badge bg-secondary ms-2">Query</span>
      </div>
      <form method="post" action="{{ url_for('action_query_run') }}">
        <div class="mb-3">
          <textarea class="form-control" name="sql" rows="5" placeholder="SELECT * FROM restaurants LIMIT 20;"></textarea>
        </div>
        <button class="btn btn-primary">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
      </form>
      {% if session.query_last %}
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped">
          <thead><tr>{% for c in session.query_last.cols %}<th>{{ c }}</th>{% endfor %}</tr></thead>
          <tbody>
            {% for row in session.query_last.rows %}
            <tr>{% for c in session.query_last.cols %}<td>{{ row[c] }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if "tables" in perms %}
  <div class="tab-pane fade" id="tab-tables">
    <div class="card p-3 mb-3">
      <div class="card-header-line">
        <h6 class="mb-0">–¢–∞–±–ª–∏—Ü—ã</h6>
        <span class="badge bg-secondary ms-2">Tables</span>
      </div>
      <form method="post" action="{{ url_for('action_tables_view') }}">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">–¢–∞–±–ª–∏—Ü–∞</label>
            <input class="form-control" list="tables-list" name="table" placeholder="restaurants">
            <datalist id="tables-list">
              {% for t in tables %}
              <option value="{{ t }}">
              {% endfor %}
            </datalist>
          </div>
          <div class="col-md-5">
            <label class="form-label">–§–∏–ª—å—Ç—Ä (WHERE)</label>
            <input class="form-control" name="where" placeholder="restaurant_id = 1">
          </div>
          <div class="col-md-2">
            <label class="form-label">–õ–∏–º–∏—Ç</label>
            <input class="form-control" name="limit" value="200">
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </div>
    {% if session.tables_last %}
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç: {{ session.tables_last.table }}</h6>
        <span class="badge bg-secondary ms-2">Tables</span>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead><tr>{% for c in session.tables_last.cols %}<th>{{ c }}</th>{% endfor %}</tr></thead>
          <tbody>
            {% for row in session.tables_last.rows %}
            <tr>{% for c in session.tables_last.cols %}<td>{{ row[c] }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  {% if "inventory" in perms %}
  <div class="tab-pane fade" id="tab-inv">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–ó–∞–ø–∞—Å—ã</h6>
        <span class="badge bg-secondary ms-2">Inventory</span>
      </div>
      <form method="post" action="{{ url_for('action_inventory_load') }}" class="row g-2 align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">–†–µ—Å—Ç–æ—Ä–∞–Ω</label>
          <select class="form-select" name="rest_id">
            {% for r in restaurants %}
            <option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="col-md-2">
          <label class="form-label">–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input class="form-control" name="qty" form="inv-update-form">
        </div>
        <div class="col-md-3">
          <label class="form-label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ (–ì–ì–ì–ì-–ú–ú-–î–î)</label>
          <input class="form-control" name="expiry" form="inv-update-form">
        </div>
        <div class="col-md-2 d-flex gap-2">
          <button class="btn btn-outline-primary w-50" form="inv-update-form" onclick="return collectSelectedStocks()">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-outline-secondary w-50" form="inv-request-form" onclick="return collectSelectedStocks()">–ó–∞—è–≤–∫–∞</button>
        </div>
      </form>
      <form id="inv-update-form" method="post" action="{{ url_for('action_inventory_update') }}">
        <input type="hidden" name="selected_ids" id="selected_ids">
        <input type="hidden" name="qty">
        <input type="hidden" name="expiry">
      </form>
      <form id="inv-request-form" method="post" action="{{ url_for('action_inventory_request') }}">
        <input type="hidden" name="selected_ids" id="req_selected_ids">
        <input type="hidden" name="qty" id="req_qty">
      </form>
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped align-middle" id="inv-table">
          <thead>
            <tr>
              <th></th>
              <th>ID</th><th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th><th>ID –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞</th><th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–ì–æ–¥–µ–Ω –¥–æ</th><th>–ú–∏–Ω. –ø–æ—Ä–æ–≥</th><th>–ü–∞—Ä—Ç–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% if stocks_last %}
            {% for row in stocks_last %}
            <tr data-stock="{{ row.id }}" data-rest="{{ row.restaurant_id }}" data-ing="{{ row.ingredient_id }}" data-min="{{ row.min_threshold }}">
              <td><input type="checkbox" name="stock_pick" value="{{ row.id }}"></td>
              <td>{{ row.id }}</td>
              <td>{{ row.restaurant_id }}</td>
              <td>{{ row.ingredient_id }}</td>
              <td>{{ row.ingredient_name }}</td>
              <td>{{ row.qty }}</td>
              <td>{{ row.expiry_date }}</td>
              <td>{{ row.min_threshold }}</td>
              <td>{{ row.batch_no }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr><td colspan="10" class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- –í–ö–õ–ê–î–ö–ê –ó–ê–Ø–í–ö–ò -->
  {% if "purchase" in perms %}
  <div class="tab-pane fade" id="tab-purchase">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É</h6>
        <span class="badge bg-secondary ms-2">Purchase Requests</span>
      </div>
      {% if purchase_requests %}
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th>
              <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
              <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
            </tr>
          </thead>
          <tbody>
          {% for pr in purchase_requests %}
            <tr>
              <td>{{ pr.id }}</td>
              <td>{{ pr.restaurant_id }}</td>
              <td>{{ pr.ingredient_name }}</td>
              <td>{{ pr.qty }}</td>
              <td>{{ pr.status }}</td>
              <td>{{ pr.created_at if pr.created_at else "‚Äî" }}</td></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info mt-3">–ù–µ—Ç –∑–∞—è–≤–æ–∫.</div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if "orders" in perms %}
  <div class="tab-pane fade" id="tab-orders">
    <div class="card p-3 mb-3">
      <div class="card-header-line">
        <h6 class="mb-0">–ó–∞–∫–∞–∑—ã</h6>
        <span class="badge bg-secondary ms-2">Orders</span>
      </div>
      <form method="post" action="{{ url_for('action_orders_load') }}" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">–†–µ—Å—Ç–æ—Ä–∞–Ω</label>
          <select class="form-select" name="rest_id">
            <option value="">–õ—é–±–æ–π</option>
            {% for r in restaurants %}<option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
          <select class="form-select" name="status">
            <option value="">–õ—é–±–æ–π</option>
            {% for s in ["new","confirmed","preparing","ready","served","completed","cancelled"] %}
            <option value="{{s}}">{{s}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫–∞–∑—ã</button>
        </div>
      </form>
      {% if orders_last %}
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped">
          <thead><tr><th>ID</th><th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th><th>–°—Ç–æ–ª</th><th>–ì–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°–æ–∑–¥–∞–Ω</th><th>–°—É–º–º–∞</th></tr></thead>
          <tbody>
            {% for o in orders_last %}
            <tr>
              <td>{{ o.id }}</td><td>{{ o.restaurant_id }}</td><td>{{ o.table_number }}</td><td>{{ o.guest_name }}</td><td>{{ o.status }}</td><td>{{ o.created_at }}</td><td>{{ o.total_amount }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    <div class="card p-3 mb-3">
      <div class="card-header-line">
        <h6 class="mb-0">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</h6>
        <span class="badge bg-secondary ms-2">Orders</span>
      </div>
      <form method="post" action="{{ url_for('action_orders_create') }}" class="row g-2">
        <div class="col-md-2">
          <select class="form-select" name="rest_id">
            {% for r in restaurants %}<option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="table" placeholder="–°—Ç–æ–ª"></div>
        <div class="col-md-2"><input class="form-control" name="guest" placeholder="–ì–æ—Å—Ç—å"></div>
        <div class="col-md-2">
          <select class="form-select" name="status">
            {% for s in ["new","confirmed","preparing","ready","served","completed","cancelled"] %}
            <option value="{{s}}">{{s}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="waiter" placeholder="ID –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞"></div>
        <div class="col-md-2"><input class="form-control" name="scheduled" placeholder="YYYY-MM-DD HH:MM"></div>
        <div class="col-md-2 mt-2"><input class="form-control" name="total" placeholder="–°—É–º–º–∞"></div>
        <div class="col-md-2 mt-2"><button class="btn btn-primary w-100">–°–æ–∑–¥–∞—Ç—å</button></div>
      </form>
    </div>
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h6>
        <span class="badge bg-secondary ms-2">Orders</span>
      </div>
      <form method="post" action="{{ url_for('action_orders_add_item') }}" class="row g-2">
        <div class="col-md-3"><input class="form-control" name="order_id" placeholder="UUID –∑–∞–∫–∞–∑–∞" required></div>
        <div class="col-md-2"><input class="form-control" name="dish_id" placeholder="ID –±–ª—é–¥–∞" required></div>
        <div class="col-md-2"><input class="form-control" name="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="1"></div>
        <div class="col-md-2"><input class="form-control" name="price" placeholder="–¶–µ–Ω–∞"></div>
        <div class="col-md-2"><button class="btn btn-outline-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </form>
    </div>
  </div>
  {% endif %}

  {% if "menu" in perms %}
  <div class="tab-pane fade" id="tab-menu">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–§–∏–ª—å—Ç—Ä –±–ª—é–¥</h6>
        <span class="badge bg-secondary ms-2">Menu</span>
      </div>
      <form method="post" action="{{ url_for('action_menu_filter') }}" class="row g-2">
        <div class="col-md-2">
          <select class="form-select" name="rest_id">
            <option value="">–õ—é–±–æ–π</option>
            {% for r in restaurants %}<option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è"></div>
        <div class="col-md-2">
          <select class="form-select" name="available">
            <option value="">–õ—é–±–æ–π</option>
            <option value="yes">–î–æ—Å—Ç—É–ø–Ω–æ</option>
            <option value="no">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</option>
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="price_min" placeholder="—Ü–µ–Ω–∞ >="></div>
        <div class="col-md-2"><input class="form-control" name="price_max" placeholder="—Ü–µ–Ω–∞ <="></div>
        <div class="col-md-2"><input class="form-control" name="keyword" placeholder="–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ"></div>
        <div class="col-md-2 mt-2"><button class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
      </form>
      {% if session.menu_last %}
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped">
          <thead><tr><th>ID</th><th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th><th>–ë–ª—é–¥–æ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th><th>–í—Ä–µ–º—è</th><th>–î–æ—Å—Ç—É–ø–Ω–æ</th></tr></thead>
          <tbody>
            {% for r in session.menu_last %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.restaurant_id }}</td>
              <td>{{ r.name }}</td>
              <td>{{ r.category }}</td>
              <td>{{ r.price }}</td>
              <td>{{ r.prep_time_minutes or "‚Äî" }}</td>
              <td {% if not r.is_available %}class="text-danger fw-bold"{% endif %}>{{ r.is_available }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if "reports" in perms %}
  <div class="tab-pane fade" id="tab-reports">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–û—Ç—á—ë—Ç—ã</h6>
        <span class="badge bg-secondary ms-2">Reports</span>
      </div>
      <form method="post" action="{{ url_for('action_reports_run') }}" class="row g-2">
        <div class="mt-3">
            <a href="{{ url_for('report_top_dishes_csv') }}"
               class="btn btn-success btn-sm"
               target="_blank">
                üì• –°–∫–∞—á–∞—Ç—å –¢–æ–ø-–±–ª—é–¥ (CSV)
            </a>
            </a>
            {% if "admin" in perms %}
            <a href="{{ url_for('action_export_all_safe_tables') }}"
               class="btn btn-warning btn-sm"
               onclick="return confirm('–í—ã–≥—Ä—É–∑–∏—Ç—å –í–°–ï –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã.')">
                üì§ –í—ã–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
            </a>
            {% endif %}
        </div>
        <div class="col-md-3">
          <select class="form-select" name="report">
            <option value="orders_per_restaurant">Orders per restaurant</option>
            <option value="top_dishes">Top dishes</option>
            <option value="low_stock">Low stock</option>
            <option value="expiring">Expiring</option>
            <option value="orders_by_status">Orders by status</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="rest_id">
            <option value="">Any restaurant</option>
            {% for r in restaurants %}<option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">Run</button>
        </div>
      </form>
      {% if session.report_last %}
      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped">
          <thead><tr>{% for c in session.report_last.cols %}<th>{{ c }}</th>{% endfor %}</tr></thead>
          <tbody>
            {% for row in session.report_last.rows %}
            <tr>{% for c in session.report_last.cols %}<td>{{ row[c] }}</td>{% endfor %}</tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if "admin" in perms %}
  <div class="tab-pane fade" id="tab-users">
    <div class="card p-3">
      <div class="card-header-line">
        <h6 class="mb-0">–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h6>
        <span class="badge bg-secondary ms-2">Users</span>
      </div>
      <form method="post" action="{{ url_for('action_users_create') }}">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Username</label>
            <input class="form-control" name="username" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Password</label>
            <input class="form-control" type="password" name="password" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Confirm</label>
            <input class="form-control" type="password" name="confirm" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Role</label>
            <select class="form-select" name="role" required>
              {% for r in roles %}
              <option value="{{ r }}">{{ r }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Restaurant (optional)</label>
            <select class="form-select" name="restaurant">
              <option value="">‚Äî</option>
              {% for r in restaurants %}
              <option value="{{ r.id }}">{{ r.id }} - {{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary">Register user</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="tab-pane fade" id="tab-help">
    <div class="card p-3">
      <div class="card-header-line">
        <h5 class="mb-0">–°–ø—Ä–∞–≤–∫–∞</h5>
        <span class="badge bg-secondary ms-2">Help</span>
      </div>
      <p class="mb-2 text-muted small">–ö—Ä–∞—Ç–∫–∏–π –≥–∞–π–¥ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>
      <div class="row gy-2 small">
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</strong>
            <ul class="mb-0">
              <li>–ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å (–∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, –∫—Ä–æ–º–µ admin).</li>
              <li>–†–æ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏.</li>
              <li>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–∞–Ω–Ω—ã–µ —É–∂–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã (–∑–∞–ø–∞—Å—ã, –∑–∞–∫–∞–∑—ã, –º–µ–Ω—é, –æ—Ç—á—ë—Ç).</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–†–æ–ª–∏ (–ø—Ä–∞–≤–∞)</strong>
            <ul class="mb-0">
              <li>admin: –≤—Å—ë, –≤–∫–ª—é—á–∞—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</li>
              <li>manager: –∑–∞–ø–∞—Å—ã, –∑–∞–∫–∞–∑—ã, –º–µ–Ω—é, –æ—Ç—á—ë—Ç—ã, —Ç–∞–±–ª–∏—Ü—ã.</li>
              <li>waiter: –∑–∞–∫–∞–∑—ã, –º–µ–Ω—é.</li>
              <li>cook: –∑–∞–ø–∞—Å—ã, –∑–∞–∫–∞–∑—ã, –º–µ–Ω—é.</li>
              <li>analyst: —Ç–∞–±–ª–∏—Ü—ã, SQL, –º–µ–Ω—é, –æ—Ç—á—ë—Ç—ã.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–ó–∞–ø–∞—Å—ã</strong>
            <ul class="mb-0">
              <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É ‚Üí –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ/—Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É.</li>
              <li>–ö–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–ó–∞–∫–∞–∑—ã</strong>
            <ul class="mb-0">
              <li>¬´–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫–∞–∑—ã¬ª ‚Äî —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É/—Å—Ç–∞—Ç—É—Å—É.</li>
              <li>–ù–∏–∂–µ —Ñ–æ—Ä–º—ã: —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–ú–µ–Ω—é</strong>
            <ul class="mb-0">
              <li>–§–∏–ª—å—Ç—Ä—ã –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, —Ü–µ–Ω–µ, –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É.</li>
              <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–û—Ç—á—ë—Ç—ã</strong>
            <ul class="mb-0">
              <li>–ì–æ—Ç–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã: –∑–∞–∫–∞–∑—ã –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º, —Ç–æ–ø-–±–ª—é–¥–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏, —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞—é—â–∏–µ, –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º.</li>
              <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª.</li>
            </ul>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-2 border rounded bg-light">
            <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</strong>
            <ul class="mb-0">
              <li>Admin –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ª—é–±–æ–π —Ä–æ–ª—å—é.</li>
              <li>–°–∞–º–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º —Ä–æ–ª—è–º, –∫—Ä–æ–º–µ admin.</li>
            </ul>
          </div>
        </div>
      </div>
      <hr>
<!--      <form class="row g-2" method="post" action="{{ url_for('action_context_set') }}">-->
<!--        <div class="col-md-3">-->
<!--          <label class="form-label">–ê–∫—Ç–∏–≤–Ω–∞—è —Ä–æ–ª—å</label>-->
<!--          <select class="form-select" name="role">-->
<!--            {% for r in roles %}-->
<!--            <option value="{{ r }}" {% if r==role %}selected{% endif %}>{{ r }}</option>-->
<!--            {% endfor %}-->
<!--          </select>-->
<!--        </div>-->
<!--        <div class="col-md-3">-->
<!--          <label class="form-label">–†–µ—Å—Ç–æ—Ä–∞–Ω</label>-->
<!--          <select class="form-select" name="rest_id">-->
<!--            <option value="">–õ—é–±–æ–π</option>-->
<!--            {% for r in restaurants %}-->
<!--            <option value="{{ r.id }}" {% if current_restaurant==r.id %}selected{% endif %}>{{ r.id }} - {{ r.name }}</option>-->
<!--            {% endfor %}-->
<!--          </select>-->
<!--        </div>-->
<!--        <div class="col-md-2 d-flex align-items-end">-->
<!--          <button class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>-->
<!--        </div>-->
<!--      </form>-->
    </div>
  </div>
</div>

<script>
function addFieldRow(containerId) {
  const container = document.getElementById(containerID);
  const row = document.createElement('div');
  row.className = 'row g-2 mb-2 kv-row';
  row.innerHTML = `
    <div class="col-md-3"><input class="form-control" name="key" placeholder="column"></div>
    <div class="col-md-4"><input class="form-control" name="value" placeholder="value"></div>
    <div class="col-md-2 d-flex align-items-center">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">x</button>
    </div>`;
  container.parentNode.insertBefore(row, container.nextSibling);
}
function removeRow(btn) {
  const row = btn.closest('.row');
  if (row) row.remove();
}
function buildJson(formId, hiddenName) {
  const form = document.getElementById(formId);
  const keys = Array.from(form.querySelectorAll('input[name="key"]'));
  const vals = Array.from(form.querySelectorAll('input[name="value"]'));
  const payload = {};
  keys.forEach((k, idx) => {
    const key = k.value.trim();
    const val = vals[idx]?.value ?? '';
    if (key) payload[key] = val;
  });
  form.querySelector(`input[name="${hiddenName}"]`).value = JSON.stringify(payload);
  return true;
}
function buildJsonFromCols(formId, hiddenName) {
  const form = document.getElementById(formId);
  const inputs = form.querySelectorAll('input[name^="col_"]');
  const payload = {};
  inputs.forEach(inp => {
    const key = inp.name.replace("col_","");
    const val = inp.value;
    if (val !== "") payload[key] = val;
  });
  form.querySelector(`input[name="${hiddenName}"]`).value = JSON.stringify(payload);
  return true;
}
function collectSelectedStocks() {
  const checked = Array.from(document.querySelectorAll('input[name="stock_pick"]:checked')).map(i => i.value);
  document.getElementById('selected_ids').value = checked.join(',');
  document.getElementById('req_selected_ids').value = checked.join(',');
  return true;
}
document.addEventListener("DOMContentLoaded", () => {
  const hash = window.location.hash;
  const activateTab = (target) => {
    const trigger = document.querySelector(`[data-bs-target="${target}"]`);
    if (trigger) {
      const tab = new bootstrap.Tab(trigger);
      tab.show();
    }
  };
  if (hash) {
    activateTab(hash);
  } else {
    activateTab("#tab-home");
  }
  const summary = {{ summary|tojson }};
  const statusCounts = {{ status_counts|tojson }};
  const ctxSum = document.getElementById("chartOrdersSum");
  if (ctxSum && summary.length) {
    new Chart(ctxSum, {
      type: "bar",
      data: {
        labels: summary.map(r => r.restaurant_name),
        datasets: [{
          label: "–°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤",
          data: summary.map(r => r.orders_sum),
          backgroundColor: "#2AABEE"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
  const ctxStatus = document.getElementById("chartStatus");
  if (ctxStatus && statusCounts.length) {
    new Chart(ctxStatus, {
      type: "doughnut",
      data: {
        labels: statusCounts.map(s => s.status),
        datasets: [{
          data: statusCounts.map(s => s.cnt),
          backgroundColor: ["#2AABEE","#74c0fc","#ffd43b","#fa5252","#51cf66","#9775fa","#ff922b"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }
});
</script>
{% endblock %}